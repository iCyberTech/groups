<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Student Data by Group</title>
  <style>
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    button {
      margin: 5px;
      padding: 5px 10px;
      cursor: pointer;
    }
    .hidden {
      display: none;
    }
    textarea {
      width: 100%;
      height: 100px;
    }
    input[type="text"], input[type="number"] {
      width: 100%;
      padding: 5px;
    }
  </style>
</head>
<body>
  <h1>Edit Student Data by Group</h1>
  <input type="text" id="groupName" placeholder="Enter Group Name">
  <button onclick="loadGroupStudents()">Search Group</button>
  <button onclick="saveAllChanges()" id="saveAllButton" class="hidden">Save All Changes</button>
  <div id="groupStudentsList"></div>

  <script type="module">
    // Import Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";

    // Your Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBxORm1Up_vSQHnT5WVTqP9I7HKWKsBBm4",
      authDomain: "school-mangement-8ca60.firebaseapp.com",
      projectId: "school-mangement-8ca60",
      storageBucket: "school-mangement-8ca60.firebasestorage.app",
      messagingSenderId: "313997383681",
      appId: "1:313997383681:web:7b1e55f6c036120c5fc800",
      measurementId: "G-P3JST7V88B"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let studentsInGroup = []; // Store loaded students globally

    // Function to load students in a group and display them for editing
    window.loadGroupStudents = async function () {
      const groupName = document.getElementById('groupName').value;
      if (!groupName) {
        alert('Please enter a group name.');
        return;
      }

      const groupStudentsListDiv = document.getElementById('groupStudentsList');
      groupStudentsListDiv.innerHTML = `<h2>Students in ${groupName}</h2>`;

      try {
        const groupDoc = await getDoc(doc(db, 'groups', groupName));
        if (!groupDoc.exists()) {
          groupStudentsListDiv.innerHTML += '<p>Group not found.</p>';
          return;
        }

        const groupData = groupDoc.data();
        const studentIds = groupData.students || [];

        // Fetch student details
        const studentsSnapshot = await getDocs(collection(db, 'students'));
        studentsInGroup = studentsSnapshot.docs
          .filter(doc => studentIds.includes(doc.id))
          .map(doc => ({ id: doc.id, ...doc.data() }));

        // Display students in a table with editable fields
        let tableHTML = `
          <table>
            <thead>
              <tr>
                <th>Name</th>
                <th>Grade</th>
                <th>Attendance</th>
                <th>Marks</th>
                <th>Semester</th>
              </tr>
            </thead>
            <tbody>
        `;

        studentsInGroup.forEach(student => {
          tableHTML += `
            <tr>
              <td><input type="text" id="name_${student.id}" value="${student.name}"></td>
              <td><input type="text" id="grade_${student.id}" value="${student.grade}"></td>
              <td><input type="number" id="attendance_${student.id}" value="${student.attendance}"></td>
              <td><input type="number" id="marks_${student.id}" value="${student.marks}"></td>
              <td><input type="text" id="semester_${student.id}" value="${student.semester}"></td>
            </tr>
            <tr>
              <td colspan="5">
                <h4>Courses</h4>
                <table>
                  <thead>
                    <tr>
                      <th>Course Name</th>
                      <th>Score</th>
                      <th>GPA</th>
                      <th>Remark</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody id="courses_${student.id}">
                  </tbody>
                </table>
                <button onclick="addCourse('${student.id}')">Add Course</button>
              </td>
            </tr>
          `;
        });

        tableHTML += `
            </tbody>
          </table>
        `;

        groupStudentsListDiv.innerHTML += tableHTML;

        // Populate the courses table for each student
        studentsInGroup.forEach(student => {
          const coursesTbody = document.getElementById(`courses_${student.id}`);
          const courses = student.courses || [];

          courses.forEach((course, index) => {
            coursesTbody.innerHTML += `
              <tr>
                <td><input type="text" id="courseName_${student.id}_${index}" value="${course.name}"></td>
                <td><input type="number" id="courseScore_${student.id}_${index}" value="${course.score}"></td>
                <td><input type="number" id="courseGPA_${student.id}_${index}" value="${course.gpa}"></td>
                <td><input type="text" id="courseRemark_${student.id}_${index}" value="${course.remark}"></td>
                <td><button onclick="removeCourse('${student.id}', ${index})">Remove</button></td>
              </tr>
            `;
          });
        });

        // Show the "Save All" button
        document.getElementById('saveAllButton').classList.remove('hidden');
      } catch (error) {
        console.error('Error loading group students: ', error);
        alert('Error loading group students. Please try again.');
      }
    };

    // Function to add a new course
    window.addCourse = function (studentId) {
      const coursesTbody = document.getElementById(`courses_${studentId}`);
      const index = coursesTbody.children.length;

      coursesTbody.innerHTML += `
        <tr>
          <td><input type="text" id="courseName_${studentId}_${index}" placeholder="Course Name"></td>
          <td><input type="number" id="courseScore_${studentId}_${index}" placeholder="Score"></td>
          <td><input type="number" id="courseGPA_${studentId}_${index}" placeholder="GPA"></td>
          <td><input type="text" id="courseRemark_${studentId}_${index}" placeholder="Remark"></td>
          <td><button onclick="removeCourse('${studentId}', ${index})">Remove</button></td>
        </tr>
      `;
    };

    // Function to remove a course
    window.removeCourse = function (studentId, index) {
      const coursesTbody = document.getElementById(`courses_${studentId}`);
      coursesTbody.removeChild(coursesTbody.children[index]);
    };

    // Function to save all changes
    window.saveAllChanges = async function () {
      try {
        for (const student of studentsInGroup) {
          const studentId = student.id;

          // Update student data
          const updatedData = {
            name: document.getElementById(`name_${studentId}`).value,
            grade: document.getElementById(`grade_${studentId}`).value,
            attendance: parseFloat(document.getElementById(`attendance_${studentId}`).value),
            marks: parseFloat(document.getElementById(`marks_${studentId}`).value),
            semester: document.getElementById(`semester_${studentId}`).value,
          };

          // Update courses
          const coursesTbody = document.getElementById(`courses_${studentId}`);
          const courses = [];
          for (let i = 0; i < coursesTbody.children.length; i++) {
            const course = {
              name: document.getElementById(`courseName_${studentId}_${i}`).value,
              score: parseFloat(document.getElementById(`courseScore_${studentId}_${i}`).value),
              gpa: parseFloat(document.getElementById(`courseGPA_${studentId}_${i}`).value),
              remark: document.getElementById(`courseRemark_${studentId}_${i}`).value,
            };
            courses.push(course);
          }
          updatedData.courses = courses;

          // Save to Firestore
          await updateDoc(doc(db, 'students', studentId), updatedData);
        }

        alert('All changes saved successfully!');
      } catch (error) {
        console.error('Error saving changes: ', error);
        alert('Error saving changes. Please try again.');
      }
    };
  </script>
</body>
</html>
